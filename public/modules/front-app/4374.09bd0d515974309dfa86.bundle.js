(self.webpackChunk=self.webpackChunk||[]).push([[4374,1198],{71614:function(e,t,r){"use strict";var a=r(92137),n=r(96156),s=r(85061),o=r(6610),u=r(5991),i=r(87757),c=r.n(i),l=r(38773),d=r(75098),h=r(76593);function p(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,a)}return r}function f(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?p(Object(r),!0).forEach((function(t){(0,n.Z)(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):p(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}var g=function(){function e(t,r){(0,o.Z)(this,e),this.component=r,this.modelName=t.modelName||"",this.dataSource=t.dataSource,t.dataSource&&"model_query"===t.dataSource.type&&(this.dataSourceName=t.dataSource.value||""),this.pageSize=t.pageSize||10,this.paginationType=t.paginationType||"pages",this.orderingField=t.orderingField||"name",this.order=t.order||"ASC",this.route="/ajax/models/".concat(this.modelName||(t.dataSource?t.dataSource.value:"")),t.dataSource&&"sql_datasource"===t.dataSource.type&&(this.route=t.dataSource.value,this.dataSourceName=t.dataSource.sql_name||"");var a=_.cloneDeep(r.props.currentModel);a.setProperty("altrpdata",r.props.currentDataStorage.getData()),this.setDefaultParams((0,h.parseParamsFromString)(t.defaultParams,a))}var t;return(0,u.Z)(e,[{key:"getResource",value:function(){return new l.Z({route:this.route})}},{key:"getFromModel",value:function(e){return e?_.isArray(e[this.dataSource.value])?(0,s.Z)(e[this.dataSource.value]):[f({},e[this.dataSource.value])]:[]}},{key:"getQueried",value:(t=(0,a.Z)(c().mark((function e(t){var r;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.dataSource||"has_many_relation"!==this.dataSource.type){e.next=4;break}this.modelUpdater?console.log(this.modelUpdater):this.modelUpdater=d.default.subscribeToModelUpdates(this.dataSource.model_name,this.component.getModelId(),this.component),e.next=10;break;case 4:return e.next=6,this.getResource().getQueried(this.getParams(t));case 6:return this.lastQuery=e.sent,_.isArray(this.lastQuery)?r=(0,s.Z)(this.lastQuery):_.isArray(this.lastQuery.data)&&(r=this.lastQuery.data),r.hasMore=this.lastQuery.hasMore,e.abrupt("return",r);case 10:case"end":return e.stop()}}),e,this)}))),function(e){return t.apply(this,arguments)})},{key:"hasMore",value:function(){return!!this.lastQuery&&this.lastQuery.hasMore}},{key:"setDefaultParams",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this.defaultParams=e}},{key:"getDefaultParams",value:function(){return this.defaultParams=this.defaultParams||{},this.defaultParams.pageSize=this.pageSize,this.defaultParams}},{key:"getParams",value:function(e){return(e=f({},_.assign(_.cloneDeep(this.getDefaultParams()),e))).page=e.page||1,_.has(e,"pageSize")&&e.pageSize<=0&&(delete e.pageSize,delete e.page),e}},{key:"getCounterStart",value:function(e){var t=1;return this.pageSize<1?t:(e=parseInt(e)||1,t=this.pageSize*(e-1)+1)}}]),e}();t.Z=g},75098:function(e,t,r){"use strict";r.r(t),r.d(t,{default:function(){return h}});var a=r(6610),n=r(5991),s=r(96156),o=r(92137),u=r(87757),i=r.n(u),c=r(38773);function l(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,a)}return r}var d=function(){function e(t,r){(0,a.Z)(this,e),this.modelName=t,r||console.error("ид модели не указан!"),this.modelId=r,this.data=null,this.subscribers=[],this.resource=new c.Z({route:"/ajax/models/".concat(this.modelName)}),this.updating=!1}var t;return(0,n.Z)(e,[{key:"subscribeToUpdates",value:function(e){this.subscribers.push(e),this.updating||(this.data&&this.callSubscribers(),this.updateData())}},{key:"updateData",value:(t=(0,o.Z)(i().mark((function e(){return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.updating=!0,e.next=3,this.resource.get(this.modelId);case 3:this.data=e.sent,this.updating=!1,this.callSubscribers();case 6:case"end":return e.stop()}}),e,this)}))),function(){return t.apply(this,arguments)})},{key:"callSubscribers",value:function(){var e=this;this.subscribers.forEach((function(t){_.isFunction(t.updateModelData)&&t.updateModelData(e.getData()),_.isFunction(t)&&t(e.getData())}))}},{key:"unsubscribe",value:function(e){this.subscribers=this.subscribers.filter((function(t){return t!==e}))}},{key:"getData",value:function(){return this.data}},{key:"updateWithData",value:function(e){this.data=_.extend(this.data,function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?l(Object(r),!0).forEach((function(t){(0,s.Z)(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):l(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}({},e)),this.callSubscribers()}}]),e}(),h=new(function(){function e(){(0,a.Z)(this,e),this.modelsStorage={}}return(0,n.Z)(e,[{key:"updateModel",value:function(e,t){this.modelsStorage["".concat(e,"::").concat(t)]||this.modelsStorage["".concat(e,"::").concat(t)].updateData()}},{key:"addModel",value:function(e){}},{key:"getModel",value:function(e,t){}},{key:"subscribeToModelUpdates",value:function(e,t,r){return t?(this.modelsStorage["".concat(e,"::").concat(t)]||(this.modelsStorage["".concat(e,"::").concat(t)]=new d(e,t)),(a=this.modelsStorage["".concat(e,"::").concat(t)]).subscribeToUpdates(r),a):null;var a}},{key:"unsubscribe",value:function(e,t,r){return t?this.modelsStorage["".concat(e,"::").concat(t)]?((a=this.modelsStorage["".concat(e,"::").concat(t)]).unsubscribe(r),a):void 0:null;var a}},{key:"updateModelWithData",value:function(e,t,r){this.modelsStorage["".concat(e,"::").concat(t)]&&this.modelsStorage["".concat(e,"::").concat(t)].updateWithData(r)}}]),e}())},74374:function(e,t,r){"use strict";var a=r(96156),n=r(92137),s=r(28481),o=r(87757),u=r.n(o),i=r(67294),c=(r(71614),r(49981)),l=r(76593);function d(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,a)}return r}function h(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?d(Object(r),!0).forEach((function(t){(0,a.Z)(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):d(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}t.Z=function(e){var t,r,a,o=[],d={forceFetchOnMount:!0,refetchOnWindowFocus:!0},p=e.children,f=void 0===p?[]:p,g=e.query,b=e.data,y=e.settings,m=e.updateToken,v={};y.tables_columns&&y.tables_columns.forEach((function(e){e.column_is_default_sorted&&!v.order_by&&(v.order_by=e.accessor,v.order=_.get(e,"column_is_default_sorted_direction","ASC"))}));var S=(0,i.useState)(1),O=(0,s.Z)(S,2),P=O[0],k=O[1],j=(0,i.useState)(v),D=(0,s.Z)(j,2),w=D[0],Z=D[1],M=(0,i.useState)({}),x=(0,s.Z)(M,2),E=x[0],N=x[1],Q=(0,i.useCallback)(function(){var e=(0,n.Z)(u().mark((function e(t){var r,a,n,s,o,i,c,l=arguments;return u().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=l.length>1&&void 0!==l[1]?l[1]:1,a=l.length>2?l[2]:void 0,n=l.length>3?l[3]:void 0,l.length>4&&l[4],s=l.length>5?l[5]:void 0,o=l.length>6?l[6]:void 0,"datasource"!==y.choose_datasource){e.next=8;break}return e.abrupt("return",b);case 8:return i={page:r},c=JSON.stringify(n),a&&(i=_.assign(a,i)),s&&(i.altrpUdateToken=s),o&&(i.order="ASC",i.order_by=o),c.length>2&&(i.filters=c),e.next=16,g.getQueried(i);case 16:return e.abrupt("return",e.sent);case 17:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}());if(g.pageSize){var z=(0,c.NE)([g.dataSourceName,P,w,E,g.getParams(),m],Q,d),A=z.status,F=z.resolvedData,T=z.latestData;o=F||o,t=A,r=z.error,a=T,(0,i.useEffect)((function(){null!=T&&T.hasMore&&c.sJ.prefetchQuery([g.dataSourceName,P+1],Q)}),[T,Q,P,w,E,m])}else{var U=(0,c.aM)([g.dataSourceName,g.getParams(),m],(function(e){return g.getResource().getQueried(h(h({},w),{},{filters:filterSettingJSON,groupBy:groupBy}))}),d),C=U.status;o=U.data,t=C,r=U.error}_.isObject(o)&&!_.isArray(o)&&(o=[o]),o.length||(o=b),_.isArray(f)||(f=[f]),_.isEmpty(b)&&(b=o),i.useEffect((function(){(0,l.setAltrpIndex)(b)}),[b]);var I=i.useMemo((function(){return _.isArray(b)?b:_.isObject(b)?[b]:[]}),[b]),q=h(h({},e),{},{data:I,_status:t,setFilterSettings:N,setSortSettings:Z,filterSetting:E,sortSetting:w,_latestData:a,setPage:k,page:P,_error:r});return f.map((function(e){return i.cloneElement(e,h(h({},q),{},{key:e.key}))}))}}}]);
//# sourceMappingURL=4374.09bd0d515974309dfa86.bundle.js.map