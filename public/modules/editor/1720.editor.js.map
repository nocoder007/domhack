{"version":3,"sources":["webpack:///./resources/modules/editor/src/js/classes/AltrpForm.js","webpack:///./resources/modules/editor/src/js/classes/modules/FormsManager.js"],"names":["formId","modelName","method","options","this","fields","submitButtons","route","dynamicURL","customRoute","resource","Resource","buttonElement","push","field","exists","map","_f","getId","component","modelID","submitText","data","customHeaders","success","confirm","forEach","fieldValidate","post","_","assign","getData","res","afterLoginRedirect","document","location","replace","afterLogoutRedirect","reload","clearInputs","updateResponseStorage","put","console","log","then","modelsManager","default","updateModelWithData","error","getQueried","delete","status","Promise","mbParseJSON","__status","alert","isFunction","get","altrp_ajax","userMessage","subject","b","getSettings","getValue","fieldLabel","fieldValue","user_message","getFieldId","appStore","dispatch","addResponseData","FormsManager","forms","formIds","fieldsStorage","form","getForm","isEmpty","AltrpForm","length","setFields","filter","addField","submit","_form","window","formsManager"],"mappings":"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","file":"1720.editor.js","sourcesContent":["import Resource from \"./Resource\";\nimport {\n  addResponseData,\n  clearAllResponseData\n} from \"../../../../front-app/src/js/store/responses-storage/actions\";\nimport { mbParseJSON } from \"../../../../front-app/src/js/helpers\";\n\n/**\n * Класс имитирующий поведение формы (собирает данные с виджетов полей и отправляет их на сервер)\n */\nclass AltrpForm {\n  /**\n   *\n   * @param {string} formId\n   * @param {string} modelName\n   * @param {string} method\n   * @param {{}} options\n   */\n  constructor(formId, modelName = \"\", method = \"POST\", options = {}) {\n    this.formId = formId;\n    this.fields = [];\n    this.submitButtons = [];\n    this.method = method;\n    this.options = options;\n    this.modelName = modelName;\n    let route = `/ajax/models/${modelName}`;\n    const { dynamicURL, customRoute } = this.options;\n\n    switch (modelName) {\n      case \"login\":\n        {\n          route = `/login`;\n        }\n        break;\n      case \"logout\":\n        {\n          route = `/logout`;\n        }\n        break;\n      case \"email\":\n        {\n          route = `/ajax/feedback`;\n        }\n        break;\n    }\n    if (customRoute) {\n      route = customRoute;\n    }\n    this.resource = new Resource({ route, dynamicURL });\n  }\n\n  /**\n   * Устанавливает список полей (в случае, если егистрация после добавления какой либо формы)\n   * @param {FrontElement[]}fields\n   */\n  setFields(fields) {\n    this.fields = fields;\n  }\n\n  /**\n   * Добавляет кнопку\n   */\n  addSubmitButton(buttonElement) {\n    this.submitButtons.push(buttonElement);\n  }\n  /**\n   * Добавляет поле\n   * @param {FrontElement} field\n   */\n  addField(field) {\n    let exists = false;\n    this.fields = this.fields.map(_f => {\n      if (_f.getId() === field.getId()) {\n        exists = true;\n        if (!field.component) {\n          return _f;\n        }\n        return field;\n      }\n      return _f;\n    });\n\n    if (!exists) {\n      this.fields.push(field);\n    }\n    return true;\n  }\n\n  /**\n   * Проверка полей перед отправкой\n   * @param {int | string | null} modelID\n   * @param {string} submitText\n   * @param {{} | null} data\n   * @param {{} | null} customHeaders\n   * @return {boolean}\n   */\n  async submit(\n    modelID = null,\n    submitText = \"\",\n    data = null,\n    customHeaders = null\n  ) {\n    let success = true;\n    if (submitText) {\n      let confirmed = await confirm(submitText);\n      if (!confirmed) {\n        return { success: false };\n      }\n    }\n    this.fields.forEach(field => {\n      if (! field.fieldValidate()) {\n        success = false;\n      }\n    });\n    if (success) {\n      try {\n        switch (this.method) {\n          case \"POST\": {\n            let res = await this.resource.post(_.assign(this.getData(), data,), customHeaders);\n            if (this.modelName === \"login\" && this.options.afterLoginRedirect) {\n              document.location.replace(this.options.afterLoginRedirect);\n              return res;\n            }\n            if (\n              this.modelName === \"logout\" &&\n              this.options.afterLogoutRedirect\n            ) {\n              document.location.replace(this.options.afterLogoutRedirect);\n              return res;\n            }\n            if (res.reload) {\n              document.location.reload();\n              return;\n            }\n            this.clearInputs();\n            this.updateResponseStorage(res);\n            return res;\n          }\n\n          case \"PUT\":\n            {\n              let res;\n              if (modelID || this.options.customRoute) {\n\n                res = await this.resource.put(\n                  modelID,\n                  _.assign(this.getData(), data),\n                  customHeaders\n                );\n                console.log(res);\n                import(/* webpackChunkName: 'ModelsManager' */\"./modules/ModelsManager\").then(modelsManager => {\n                  modelsManager.default.updateModelWithData(\n                    this.modelName,\n                    modelID,\n                    this.getData()\n                  );\n                });\n                // this.clearInputs();\n                this.updateResponseStorage(res);\n                return res;\n              }\n              console.error(\n                \"Не удалось получить ИД модели для обновления или customRoute!\"\n              );\n            }\n            break;\n          case \"GET\": {\n            // return await alert(JSON.stringify(this.getData()));\n            let res;\n            res = await this.resource.getQueried(\n              _.assign(this.getData(), data),\n                customHeaders\n            );\n            this.updateResponseStorage(res);\n            return res;\n          }\n          case \"DELETE\":\n            {\n              if (modelID || this.options.customRoute) {\n                // return await await alert('Удаление!');\n                return await this.resource.delete(\n                  modelID,\n                  _.assign(this.getData(), data),\n                  customHeaders\n                );\n              }\n              console.error(\n                \"Не удалось получить ИД модели для удаления или customRoute!\"\n              );\n            }\n            break;\n        }\n      } catch (error) {\n        let status = error.status;\n        if(error.res instanceof Promise){\n          error = error.res;\n        }\n        if (error instanceof Promise) {\n          error = await error.then();\n          error = mbParseJSON(error, error);\n          error.data && (error = error.data);\n          status && (error.data ? (error.data.__status = status) : (error.__status = status));\n          this.updateResponseStorage(error);\n        }\n        return { success: false, error };\n      }\n    } else {\n      await alert(\"Пожалуйста, заполните все обязательные поля\");\n      return { success: false };\n    }\n  }\n\n  /**\n   * Очистим поля формы\n   */\n  clearInputs() {\n    this.fields.forEach(field => {\n      try {\n        if (_.isFunction(_.get(field, \"component.setState\"))) {\n          // field.component.setState(state => ({ ...state, value: \"\" }));\n        }\n      } catch (error) {\n        console.error(error);\n      }\n    });\n  }\n\n  /**\n   * Собирает данные с полей для отправки\n   * @return {{}}\n   */\n  getData() {\n    let data = { altrp_ajax: true };\n\n    if (this.modelName === \"email\") {\n      let userMessage = \"\";\n      let subject = \"Altrp Email\";\n\n      this.submitButtons.forEach(b => {\n        if (b.getSettings(\"email_subject\")) {\n          subject = b.getSettings(\"email_subject\");\n        }\n      });\n      this.fields.forEach(field => {\n        if (field.getValue() !== null) {\n          let fieldLabel =\n            field.getSettings(\"content_label\") ||\n            field.getSettings(\"content_placeholder\") ||\n            \"\";\n          let fieldValue = field.getValue();\n          userMessage += `${fieldLabel}: ${fieldValue} <br/> `;\n        }\n      });\n      data.subject = subject;\n      data.user_message = userMessage;\n    } else {\n      this.fields.forEach(field => {\n        data[field.getFieldId()] = field.getValue();\n      });\n    }\n    return data;\n  }\n\n  /**\n   * Обновить responses-storage данными\n   * @param {{}} res\n   */\n  updateResponseStorage(res = {}) {\n    appStore.dispatch(addResponseData(this.formId, res));\n  }\n}\n\nexport default AltrpForm;\n","import AltrpForm from \"../AltrpForm\";\r\n/**\r\n * Класс менеджер форм для фронтенда/редактора\r\n */\r\nclass FormsManager {\r\n  constructor(){\r\n    /**\r\n     *\r\n     * @type {AltrpForm[]}\r\n     */\r\n    this.forms = [];\r\n    /**\r\n     *\r\n     * @type {string[]}\r\n     */\r\n    this.formIds = [];\r\n    this.fieldsStorage = {};\r\n  }\r\n\r\n  /**\r\n   * Регистрирует новую форму.\r\n   * @param {string} formId\r\n   * @param {string} modelName\r\n   * @param {string} method\r\n   * @param {{}} options\r\n   * @return {AltrpForm}\r\n   */\r\n  registerForm(formId, modelName, method, options = {}){\r\n    let form = this.getForm(formId);\r\n    if(! form){\r\n      form = new AltrpForm(formId, modelName, method, options);\r\n      /**\r\n       * Если в хранилище есть список полей для указанной формы,\r\n       * то передаем их в форму, а на список ссылку удаляем\r\n       */\r\n\r\n      if(this.fieldsStorage[formId] && this.fieldsStorage[formId].length){\r\n        form.setFields(this.fieldsStorage[formId]);\r\n        delete this.fieldsStorage[formId]\r\n      }\r\n      this.forms.push(form);\r\n    } else if (! _.isEmpty(options)){\r\n      form.options = options\r\n    }\r\n    return form;\r\n  }\r\n\r\n  /**\r\n   * Удаляем форму по ID\r\n   */\r\n  deleteFormById(formId){\r\n    this.forms = this.forms.filter(form => form.formId !== formId);\r\n  }\r\n  /**\r\n   * Добавляет поле к форме\r\n   * сохраняет поле в fieldsStorage если форма еще не добавлена\r\n   * @param {string} formId\r\n   * @param {FrontElement} field\r\n   * @return {boolean}\r\n   */\r\n  addField(formId, field){\r\n    let form = this.getForm(formId);\r\n    if(! form){\r\n      this.fieldsStorage[formId] = this.fieldsStorage[formId] || [];\r\n      this.fieldsStorage[formId].push(field);\r\n      return true;\r\n    }\r\n    return form.addField(field)\r\n  }\r\n\r\n  /**\r\n   * После смену страницы нужно почистить хранилище полей\r\n   */\r\n  clearFieldsStorage(){\r\n    this.fieldsStorage = {};\r\n  }\r\n  /**\r\n   * Отправляет форму\r\n   * @param {string} formId\r\n   * @param {int | null} modelID\r\n   * @return {boolean}\r\n   */\r\n  submitForm(formId, modelID){\r\n    if(! this.getForm(formId)){\r\n      console.error('Форма не найдена');\r\n      return false;\r\n    }\r\n    return this.getForm(formId).submit(modelID);\r\n  }\r\n  /**\r\n   * Получить форму по id\r\n   * @param {string} formId\r\n   * @return {AltrpForm | null}\r\n   */\r\n  getForm(formId){\r\n    let _form = null;\r\n    this.forms.forEach(form=>{\r\n      /**\r\n       * @member {AltrpForm}form\r\n       */\r\n      if(form.formId === formId){\r\n        _form = form;\r\n      }\r\n    });\r\n    return _form;\r\n  }\r\n\r\n  /**\r\n   * Очищает все формы\r\n   */\r\n  clearFormsStore(){\r\n    this.forms = [];\r\n  }\r\n}\r\nwindow.formsManager = new FormsManager();\r\n\r\nexport default window.formsManager;\r\n"],"sourceRoot":""}